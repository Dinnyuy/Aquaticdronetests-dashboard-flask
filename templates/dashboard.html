<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATAWI-3A3 | Drone Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
    <style>
        :root {
            --primary: #0f4c75;
            --secondary: #3282b8;
            --accent: #4CAF50;
            --warning: #FF9800;
            --danger: #f44336;
            --light: #f0f4f8;
            --dark: #1b262c;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #f5f7fa; color: #333; line-height: 1.6; }
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 1rem 2rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000; height: 70px; }
        .header-left { display: flex; align-items: center; gap: 1.5rem; }
        .logo { height: 50px; width: 50px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .header-left h1 { font-size: 1.5rem; margin-bottom: 0.2rem; }
        .header-left .subtitle { font-size: 0.9rem; opacity: 0.9; }
        .header-right { display: flex; align-items: center; gap: 1.5rem; }
        .dashboard-switcher { display: flex; align-items: center; gap: 0.5rem; margin-right: 1rem; }
        .dashboard-switcher select { padding: 0.5rem; border-radius: 4px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); color: white; cursor: pointer; }
        .dashboard-switcher select option { background: white; color: #333; }
        .user-menu { position: relative; }
        .user-btn { background: rgba(255,255,255,0.15); border: none; color: white; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-width: 150px; display: none; z-index: 1000; margin-top: 5px; }
        .user-menu:hover .dropdown-menu { display: block; }
        .dropdown-menu a { display: block; padding: 0.8rem 1rem; color: #333; text-decoration: none; transition: background 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .dropdown-menu a:hover { background: #f5f5f5; }
        .dashboard-container { display: flex; min-height: calc(100vh - 70px); margin-top: 70px; }
        .sidebar { width: 250px; background: white; border-right: 1px solid #e0e0e0; padding: 1.5rem 0; position: fixed; top: 70px; left: 0; bottom: 0; overflow-y: auto; z-index: 999; }
        .nav-menu { display: flex; flex-direction: column; gap: 0.5rem; padding: 0 1rem; }
        .nav-btn { background: none; border: none; padding: 1rem 1.5rem; text-align: left; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 1rem; color: #555; transition: all 0.3s; font-size: 1rem; font-weight: 500; }
        .nav-btn:hover, .nav-btn.active { background: #f0f7ff; color: var(--primary); transform: translateX(5px); }
        .nav-btn.active { background: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 12px rgba(15,76,117,0.15); }
        .sidebar-footer { margin-top: auto; padding: 1rem; border-top: 1px solid #eee; font-size: 0.8rem; color: #666; }
        .main-content { flex: 1; padding: 2rem; margin-left: 250px; overflow-y: auto; }
        .dashboard-section { display: none; animation: fadeIn 0.5s ease; }
        .dashboard-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.8rem; color: var(--primary); margin-bottom: 1.5rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e0f7fa; display: flex; align-items: center; gap: 0.8rem; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.3s ease; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; }
        .temp-card::before { background: linear-gradient(90deg, #FF5252, #FF9E80); }
        .turbidity-card::before { background: linear-gradient(90deg, #2196F3, #81D4FA); }
        .conductivity-card::before { background: linear-gradient(90deg, #4CAF50, #81C784); }
        .ph-card::before { background: linear-gradient(90deg, #9C27B0, #CE93D8); }
        .do-card::before { background: linear-gradient(90deg, #FF9800, #FFCC80); }
        .gps-card::before { background: linear-gradient(90deg, #795548, #A1887F); }
        .map-card::before { background: linear-gradient(90deg, #00BCD4, #80DEEA); }
        .stats-card::before { background: linear-gradient(90deg, #673AB7, #B39DDB); }
        .alert-card::before { background: linear-gradient(90deg, #f44336, #EF9A9A); }
        .camera-card::before { background: linear-gradient(90deg, #009688, #80CBC4); }
        .analysis-card::before { background: linear-gradient(90deg, #607D8B, #90A4AE); }
        .card-title { font-size: 1.1rem; color: var(--dark); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .sensor-value { font-size: 2.2rem; font-weight: 600; margin: 0.5rem 0; }
        .sensor-unit { color: #666; font-size: 0.95rem; }
        .sensor-status { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; margin-top: 0.5rem; font-weight: 500; }
        .status-normal { background: #e8f5e9; color: #2e7d32; }
        .status-warning { background: #fff3e0; color: #f57c00; }
        .status-alert { background: #ffebee; color: #c62828; }
        .threshold-indicator { position: absolute; top: 10px; right: 10px; width: 12px; height: 12px; border-radius: 50%; background: #f44336; display: none; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(244,67,54,0.7); } 70% { box-shadow: 0 0 0 10px rgba(244,67,54,0); } 100% { box-shadow: 0 0 0 0 rgba(244,67,54,0); } }
        .card.alert { border: 2px solid #f44336 !important; animation: alert-pulse 1.5s infinite; }
        @keyframes alert-pulse { 0% { box-shadow: 0 0 5px rgba(244,67,54,0.5); } 50% { box-shadow: 0 0 20px rgba(244,67,54,0.8); } 100% { box-shadow: 0 0 5px rgba(244,67,54,0.5); } }
        .chart-container { height: 350px; width: 100%; margin-top: 1rem; }
        .chart-container-large { height: 450px; width: 100%; margin-top: 1rem; }
        .chart-container-xlarge { height: 500px; width: 100%; margin-top: 1rem; }
        .map-container { height: 400px; border-radius: 8px; overflow: hidden; margin-top: 1rem; border: 1px solid #ddd; }
        .map-camera-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1rem; }
        .camera-container { position: relative; border-radius: 8px; overflow: hidden; background: #000; height: 400px; }
        .camera-feed { width: 100%; height: 100%; object-fit: cover; display: block; }
        .camera-overlay { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 4px; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
        .time-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }
        .time-btn { padding: 0.5rem 1rem; background: white; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .time-btn:hover { background: #f0f0f0; }
        .time-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .action-btn { padding: 0.5rem 1rem; background: var(--secondary); color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s; }
        .action-btn:hover { background: var(--primary); transform: translateY(-2px); }
        .alert-banner { background: linear-gradient(135deg, #ff5252, #ff9e80); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: none; animation: pulse 2s infinite; }
        .alert-banner-content { display: flex; justify-content: space-between; align-items: center; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .status-item { text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; }
        .status-value { font-size: 1.5rem; font-weight: 600; color: var(--primary); margin-top: 0.5rem; }
        .status-label { font-size: 0.9rem; color: #666; }
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .stats-table th { background: #f8f9fa; padding: 0.8rem; text-align: left; font-weight: 500; border-bottom: 2px solid #e0e0e0; }
        .stats-table td { padding: 0.8rem; border-bottom: 1px solid #eee; }
        .stats-table tr:hover { background: #f8f9fa; }
        .quick-graph { height: 200px; margin-top: 1rem; width: 100%; }
        .system-status-bar { background: #f8f9fa; padding: 0.5rem 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; }
        .indicator-dot { width: 10px; height: 10px; border-radius: 50%; }
        .indicator-dot.connected { background: #4CAF50; animation: pulse 2s infinite; }
        .indicator-dot.disconnected { background: #f44336; }
        .indicator-dot.error { background: #FF9800; }
        .overview-main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem; }
        .threshold-line { border-top: 2px dashed; position: relative; }
        .threshold-label { position: absolute; right: 0; top: -10px; background: white; padding: 2px 8px; font-size: 0.8rem; border-radius: 10px; border: 1px solid #ddd; }
        .analysis-box { background: #f8f9fa; border-left: 4px solid var(--primary); padding: 1rem; border-radius: 4px; margin-top: 1rem; }
        .analysis-box h4 { color: var(--primary); margin-bottom: 0.5rem; }
        .ballast-indicator { padding: 1rem; border-radius: 8px; text-align: center; font-weight: 600; margin-top: 1rem; transition: all 0.3s; font-size: 1.1rem; }
        .ballast-indicator.normal { background: #e8f5e9; color: #2e7d32; border: 2px solid #4CAF50; }
        .ballast-indicator.detected { background: #ffebee; color: #c62828; border: 2px solid #f44336; animation: alert-pulse 1.5s infinite; }
        .ballast-indicator.suspected { background: #fff3e0; color: #f57c00; border: 2px solid #FF9800; }
        .sensor-thresholds { margin-top: 1rem; font-size: 0.9rem; }
        .threshold-item { display: flex; justify-content: space-between; padding: 0.3rem 0; border-bottom: 1px solid #eee; }
        .threshold-item.exceeded { color: #f44336; font-weight: 500; }
        .threshold-item.normal { color: #4CAF50; }
        .certainty-meter { width: 100%; height: 30px; background: #f0f0f0; border-radius: 15px; margin: 1rem 0; overflow: hidden; position: relative; }
        .certainty-fill { height: 100%; border-radius: 15px; transition: width 1s ease-in-out; position: relative; }
        .certainty-fill.low { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
        .certainty-fill.medium { background: linear-gradient(90deg, #FF9800, #FFC107); }
        .certainty-fill.high { background: linear-gradient(90deg, #f44336, #FF5252); }
        .certainty-text { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #333; text-shadow: 0 1px 1px rgba(255,255,255,0.8); }
        .certainty-percentage { font-size: 2.5rem; font-weight: 700; text-align: center; margin: 1rem 0; transition: all 0.5s ease; }
        .certainty-percentage.low { color: #4CAF50; }
        .certainty-percentage.medium { color: #FF9800; }
        .certainty-percentage.high { color: #f44336; animation: pulse 1.5s infinite; }
        .probability-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .probability-item { text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px; }
        .probability-value { font-size: 1.5rem; font-weight: 600; margin-top: 0.5rem; }
        .probability-label { font-size: 0.9rem; color: #666; }
        .graphs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(700px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
        .full-width-graph { width: 100%; height: 500px; margin-top: 1rem; }
                .dashboard-footer {
            text-align: center;
            padding: 1.5rem 0;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #e0e0e0;
            margin-top: 2rem;
            background: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
        }
        @media (max-width: 1200px) { .overview-main-grid { grid-template-columns: 1fr; } .map-camera-grid { grid-template-columns: 1fr; } .graphs-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { width: 70px; padding: 1rem 0; } .nav-btn span { display: none; } .nav-btn { justify-content: center; padding: 1rem; } .nav-btn:hover { transform: none; } .main-content { margin-left: 70px; } .dashboard-grid { grid-template-columns: 1fr; } .header-left h1 { font-size: 1.2rem; } .header-left .subtitle { display: none; } .dashboard-switcher { display: none; } .graphs-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="{{ url_for('static', filename='Dashboard logo.png') }}" alt="ATAWI-3A3 Logo" class="logo">
            <div>
                <h1>ATAWI E-Soft</h1>
                <div class="subtitle">ATAWI-3A3 | Real-time Water Quality Monitoring</div>
            </div>
        </div>
        
        <div class="header-right">
            <div class="dashboard-switcher">
                <i class="fas fa-exchange-alt"></i>
                <select id="dashboardSelector">
                    <option value="drone" selected>Drone Dashboard</option>
                    <option value="buoy">Buoy Dashboard</option>
                </select>
            </div>
            
            <div class="status-indicator">
                <div class="indicator-dot connected" id="connectionDot"></div>
                <span id="connectionStatus">Connected</span>
            </div>
            
            <div class="user-menu">
                <button class="user-btn">
                    <i class="fas fa-user-circle"></i>
                    <span id="username">{{ current_user.username }}</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu">
                    <a href="/profile"><i class="fas fa-user"></i> Profile</a>
                    <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="dashboard-container">
        <div class="sidebar">
            <nav class="nav-menu">
                <button class="nav-btn active" data-section="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </button>
                <button class="nav-btn" data-section="graphs">
                    <i class="fas fa-chart-line"></i>
                    <span>Time Series</span>
                </button>
                <button class="nav-btn" data-section="maps">
                    <i class="fas fa-map"></i>
                    <span>Maps & GPS</span>
                </button>
                <button class="nav-btn" data-section="statistics">
                    <i class="fas fa-chart-pie"></i>
                    <span>Statistics</span>
                </button>
                <button class="nav-btn" data-section="debug">
                    <i class="fas fa-bug"></i>
                    <span>Debug & Logs</span>
                </button>
                <button class="nav-btn" data-section="export">
                    <i class="fas fa-download"></i>
                    <span>Export Data</span>
                </button>
            </nav>
            
            <div class="sidebar-footer">
                <div style="margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem;">
                        <div class="indicator-dot connected" id="sidebarStatusDot"></div>
                        <span id="sidebarStatusText">System Online</span>
                    </div>
                    <div id="sidebarTime" style="font-family: monospace;">--:--:--</div>
                </div>
                <div style="font-size: 0.7rem; color: #999; margin-top: 1rem;">
                    ATAWI-3A3 | v2.0
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Alert Banner -->
            <div class="alert-banner" id="alertBanner">
                <div class="alert-banner-content">
                    <div>
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>BALLAST WATER DETECTED!</strong>
                        <span id="alertMessage">High probability of ballast water contamination</span>
                    </div>
                    <button onclick="document.getElementById('alertBanner').style.display='none'" style="background: none; border: none; color: white; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- System Status Bar -->
            <div class="system-status-bar">
                <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                    <div class="status-indicator">
                        <div class="indicator-dot connected" id="droneStatusDot"></div>
                        <span>Drone: <span id="droneStatusText">Connected</span></span>
                    </div>
                    <div class="status-indicator">
                        <div class="indicator-dot connected" id="cameraStatusDot"></div>
                        <span>Camera: <span id="cameraStatusText">Active</span></span>
                    </div>
                    <div class="status-indicator">
                        <i class="fas fa-database"></i>
                        <span>Data: <span id="dataStatusText">Streaming</span></span>
                    </div>
                    <div class="status-indicator">
                        <i class="fas fa-battery-full"></i>
                        <span>Battery: <span id="batteryStatusText">85%</span></span>
                    </div>
                </div>
                <div id="lastUpdateTime" style="color: #666; font-size: 0.9rem;">
                    Last update: --
                </div>
            </div>
            
            <!-- Overview Section -->
            <div id="overviewSection" class="dashboard-section active">
                <h2 class="section-title">
                    <i class="fas fa-tachometer-alt"></i>
                    Real-time Monitoring Dashboard
                </h2>
                
                <div class="overview-main-grid">
                    <!-- Left Column: Sensor Cards -->
                    <div>
                        <div class="dashboard-grid">
                            <div class="card temp-card">
                                <div class="threshold-indicator" id="tempThresholdIndicator"></div>
                                <div class="card-title"><i class="fas fa-thermometer-half"></i> Water Temperature</div>
                                <div class="sensor-value" id="tempValue">-- °C</div>
                                <div class="sensor-unit">Optimal: 26-29°C | Threshold: 32°C</div>
                                <div class="sensor-status status-normal" id="tempStatus">Normal</div>
                            </div>
                            
                            <div class="card turbidity-card">
                                <div class="threshold-indicator" id="turbidityThresholdIndicator"></div>
                                <div class="card-title"><i class="fas fa-wind"></i> Turbidity</div>
                                <div class="sensor-value" id="turbidityValue">-- NTU</div>
                                <div class="sensor-unit">Optimal: &lt; 5 NTU | Threshold: 41 NTU</div>
                                <div class="sensor-status status-normal" id="turbidityStatus">Normal</div>
                            </div>
                            
                            <div class="card conductivity-card">
                                <div class="threshold-indicator" id="conductivityThresholdIndicator"></div>
                                <div class="card-title"><i class="fas fa-bolt"></i> Conductivity</div>
                                <div class="sensor-value" id="conductivityValue">-- mS/cm</div>
                                <div class="sensor-unit">Salinity: <span id="salinityValue">-- PSU</span> | Threshold: 12 mS/cm</div>
                                <div class="sensor-status status-normal" id="conductivityStatus">Normal</div>
                            </div>
                            
                            <div class="card ph-card">
                                <div class="threshold-indicator" id="phThresholdIndicator"></div>
                                <div class="card-title"><i class="fas fa-vial"></i> pH Level</div>
                                <div class="sensor-value" id="phValue">--</div>
                                <div class="sensor-unit">Optimal: 6.5-8.5 | Threshold: 6.5-7.5</div>
                                <div class="sensor-status status-normal" id="phStatus">Normal</div>
                            </div>
                            
                            <div class="card do-card">
                                <div class="threshold-indicator" id="doThresholdIndicator"></div>
                                <div class="card-title"><i class="fas fa-wind"></i> Dissolved Oxygen</div>
                                <div class="sensor-value" id="doValue">-- mg/L</div>
                                <div class="sensor-unit">Optimal: &gt; 5.0 mg/L | Threshold: 5.0 mg/L</div>
                                <div class="sensor-status status-normal" id="doStatus">Normal</div>
                            </div>
                            
                            <div class="card gps-card">
                                <div class="card-title"><i class="fas fa-map-marker-alt"></i> GPS Position</div>
                                <div class="sensor-value" id="gpsValue">--, --</div>
                                <div class="sensor-unit" id="gpsStatus">GPS: Searching...</div>
                                <div style="margin-top: 0.5rem; font-size: 0.9rem;">
                                    Battery: <span id="batteryValue">--%</span> | Speed: <span id="speedValue">-- m/s</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Graphs -->
                        <div class="card map-card" style="margin-top: 1.5rem;">
                            <div class="card-title"><i class="fas fa-chart-line"></i> Recent Trends (1 Hour)</div>
                            <div class="quick-graph">
                                <canvas id="quickTrendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Map, Camera and Stats -->
                    <div>
                        <!-- Map and Camera -->
                        <div class="card map-card">
                            <div class="card-title"><i class="fas fa-map"></i> Drone Location & Live Camera</div>
                            <div class="map-camera-grid">
                                <div class="map-container" id="droneMap"></div>
                                <div class="camera-container">
                                    <img src="/video_feed" class="camera-feed" alt="Drone Camera Feed">
                                    <div class="camera-overlay">
                                        <i class="fas fa-camera"></i>
                                        <span id="cameraFeedStatus">Live</span>
                                        <span id="cameraType">(USB Webcam)</span>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                                <i class="fas fa-info-circle"></i> Real-time drone position and live camera feed
                            </div>
                        </div>
                        
                        <!-- Statistics Summary -->
                        <div class="card stats-card" style="margin-top: 1.5rem;">
                            <div class="card-title"><i class="fas fa-chart-bar"></i> Quick Statistics (24h)</div>
                            <table class="stats-table" id="quickStatsTable">
                                <thead>
                                    <tr>
                                        <th>Parameter</th>
                                        <th>Current</th>
                                        <th>Avg</th>
                                        <th>Max</th>
                                    </tr>
                                </thead>
                                <tbody id="quickStatsBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- System Status -->
                        <div class="card" style="margin-top: 1.5rem;">
                            <div class="card-title"><i class="fas fa-microchip"></i> System Status</div>
                            <div class="status-grid">
                                <div class="status-item">
                                    <div class="status-label">Data Points</div>
                                    <div class="status-value" id="dataPointsCount">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Alerts (24h)</div>
                                    <div class="status-value" id="alertsCount">0</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Uptime</div>
                                    <div class="status-value" id="uptimeValue">00:00</div>
                                </div>
                                <div class="status-item">
                                    <div class="status-label">Sampling Rate</div>
                                    <div class="status-value">3s</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Alerts -->
                <div class="card alert-card" style="margin-top: 1.5rem;" id="recentAlertsCard">
                    <div class="card-title"><i class="fas fa-exclamation-triangle"></i> Recent Alerts</div>
                    <div id="recentAlertsContent" style="text-align: center; padding: 2rem; color: #666;">
                        No recent alerts
                    </div>
                </div>
            </div>
            
            <!-- Graphs Section -->
            <div id="graphsSection" class="dashboard-section">
                <h2 class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Time Series Analysis & Ballast Water Detection
                </h2>
                
                <div class="time-controls">
                    <span>Time Range:</span>
                    <button class="time-btn active" onclick="loadTimeSeriesData(1, event)">1 Hour</button>
                    <button class="time-btn" onclick="loadTimeSeriesData(6, event)">6 Hours</button>
                    <button class="time-btn" onclick="loadTimeSeriesData(24, event)">24 Hours</button>
                    <button class="time-btn" onclick="loadTimeSeriesData(168, event)">7 Days</button>
                    <button class="time-btn" onclick="loadTimeSeriesData(720, event)">30 Days</button>
                    <div style="margin-left: auto; font-size: 0.9rem; color: #666;">
                        <i class="fas fa-clock"></i> Timezone: <span id="timezoneDisplay">Local Time</span>
                    </div>
                </div>
                
                <!-- Ballast Water Detection Status with Percentage -->
                <div class="card analysis-card" style="margin-bottom: 1.5rem;">
                    <div class="card-title"><i class="fas fa-water"></i> Ballast Water Detection Analysis</div>
                    
                    <div class="certainty-percentage" id="certaintyPercentage">0%</div>
                    
                    <div class="certainty-meter">
                        <div class="certainty-fill" id="certaintyFill" style="width: 0%">
                            <div class="certainty-text" id="certaintyText">0% Certainty</div>
                        </div>
                    </div>
                    
                    <div id="ballastStatus" class="ballast-indicator normal">
                        <i class="fas fa-check-circle"></i> No Ballast Water Detected
                    </div>
                    
                    <!-- Probability Breakdown -->
                    <div class="probability-breakdown">
                        <div class="probability-item">
                            <div class="probability-label">Temperature</div>
                            <div class="probability-value" id="probTemp">0%</div>
                        </div>
                        <div class="probability-item">
                            <div class="probability-label">Turbidity</div>
                            <div class="probability-value" id="probTurbidity">0%</div>
                        </div>
                        <div class="probability-item">
                            <div class="probability-label">Conductivity</div>
                            <div class="probability-value" id="probConductivity">0%</div>
                        </div>
                        <div class="probability-item">
                            <div class="probability-label">pH Level</div>
                            <div class="probability-value" id="probPH">0%</div>
                        </div>
                        <div class="probability-item">
                            <div class="probability-label">Dissolved Oxygen</div>
                            <div class="probability-value" id="probDO">0%</div>
                        </div>
                    </div>
                    
                    <div class="analysis-box">
                        <h4><i class="fas fa-info-circle"></i> Detection Logic</h4>
                        <p><strong>Ballast Water probability calculated based on:</strong></p>
                        <div class="sensor-thresholds">
                            <div class="threshold-item" id="thresholdTemp">
                                <span>Temperature: >32°C</span>
                                <span id="thresholdTempStatus">Normal</span>
                            </div>
                            <div class="threshold-item" id="thresholdTurbidity">
                                <span>Turbidity: >41 NTU</span>
                                <span id="thresholdTurbidityStatus">Normal</span>
                            </div>
                            <div class="threshold-item" id="thresholdConductivity">
                                <span>Conductivity: >12 mS/cm</span>
                                <span id="thresholdConductivityStatus">Normal</span>
                            </div>
                            <div class="threshold-item" id="thresholdPH">
                                <span>pH: &lt;6.5 or >7.5</span>
                                <span id="thresholdPHStatus">Normal</span>
                            </div>
                            <div class="threshold-item" id="thresholdDO">
                                <span>Dissolved Oxygen: &lt;5 mg/L</span>
                                <span id="thresholdDOStatus">Normal</span>
                            </div>
                        </div>
                        <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                            <i class="fas fa-lightbulb"></i> <strong>Probability Calculation:</strong>
                            <ul style="padding-left: 1.5rem; margin-top: 0.5rem; font-size: 0.9rem;">
                                <li>Each exceeded sensor adds 15-25% probability</li>
                                <li>3+ exceeded sensors triggers >70% probability</li>
                                <li>Magnitude of exceedance increases probability</li>
                                <li>Sustained exceedance over time increases certainty</li>
                            </ul>
                        </p>
                    </div>
                </div>
                
                <!-- Combined Multi-Sensor Graph -->
                <div class="card">
                    <div class="card-title"><i class="fas fa-chart-line"></i> Multi-Sensor Time Series (All Parameters)</div>
                    <div class="full-width-graph">
                        <canvas id="timeSeriesChart"></canvas>
                    </div>
                    <div class="analysis-box">
                        <h4><i class="fas fa-chart-bar"></i> Graph Analysis</h4>
                        <p><strong>What to look for in the combined graph:</strong></p>
                        <ul style="padding-left: 1.5rem; margin-top: 0.5rem;">
                            <li><strong>Simultaneous spikes</strong> in multiple sensors indicate potential contamination</li>
                            <li><strong>Correlation patterns</strong> between turbidity and conductivity suggest ballast water</li>
                            <li><strong>Temperature anomalies</strong> combined with pH shifts indicate foreign water sources</li>
                            <li><strong>Dissolved oxygen drops</strong> with increased turbidity suggest organic contamination</li>
                        </ul>
                        <p style="margin-top: 0.5rem;"><strong>Current Analysis:</strong> <span id="graphAnalysisText">Analyzing patterns...</span></p>
                    </div>
                </div>
                
                <!-- Individual Sensor Graphs -->
                <div style="margin-top: 1.5rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-chart-area"></i> Individual Sensor Analysis
                    </h3>
                    <div class="graphs-grid">
                        <!-- Temperature Chart -->
                        <div class="card">
                            <div class="card-title"><i class="fas fa-thermometer-half"></i> Temperature Trend Analysis</div>
                            <div class="chart-container">
                                <canvas id="temperatureChart"></canvas>
                            </div>
                            <div class="analysis-box">
                                <h4><i class="fas fa-temperature-high"></i> Significance:</h4>
                                <p>Ballast water often has different temperature than local water. Sudden temperature changes (>2°C) or sustained deviations from baseline indicate foreign water intrusion.</p>
                                <p><strong>Threshold:</strong> 32°C | <strong>Current:</strong> <span id="tempAnalysisValue">--°C</span></p>
                            </div>
                        </div>
                        
                        <!-- Turbidity Chart -->
                        <div class="card">
                            <div class="card-title"><i class="fas fa-wind"></i> Turbidity Trend Analysis</div>
                            <div class="chart-container">
                                <canvas id="turbidityChart"></canvas>
                            </div>
                            <div class="analysis-box">
                                <h4><i class="fas fa-water"></i> Significance:</h4>
                                <p>High turbidity (>41 NTU) indicates suspended solids, sediments, or organic matter. Ballast water often carries sediments from different regions, causing turbidity spikes.</p>
                                <p><strong>Threshold:</strong> 41 NTU | <strong>Current:</strong> <span id="turbidityAnalysisValue">-- NTU</span></p>
                            </div>
                        </div>
                        
                        <!-- Conductivity Chart -->
                        <div class="card">
                            <div class="card-title"><i class="fas fa-bolt"></i> Conductivity & Salinity Analysis</div>
                            <div class="chart-container">
                                <canvas id="conductivityChart"></canvas>
                            </div>
                            <div class="analysis-box">
                                <h4><i class="fas fa-tint"></i> Significance:</h4>
                                <p>Conductivity (>12 mS/cm) indicates high salinity or dissolved solids. Different water bodies have unique conductivity signatures - changes suggest mixing with foreign water.</p>
                                <p><strong>Threshold:</strong> 12 mS/cm | <strong>Current:</strong> <span id="conductivityAnalysisValue">-- mS/cm</span></p>
                            </div>
                        </div>
                        
                        <!-- pH and DO Combined Chart -->
                        <div class="card">
                            <div class="card-title"><i class="fas fa-vial"></i> pH & Dissolved Oxygen Analysis</div>
                            <div class="chart-container">
                                <canvas id="phDoChart"></canvas>
                            </div>
                            <div class="analysis-box">
                                <h4><i class="fas fa-flask"></i> Significance:</h4>
                                <p>pH outside 6.5-7.5 range or DO below 5 mg/L indicates chemical imbalances. Ballast water can alter local water chemistry, affecting aquatic life and indicating contamination.</p>
                                <p><strong>pH Range:</strong> 6.5-7.5 | <strong>DO Min:</strong> 5 mg/L</p>
                                <p><strong>Current pH:</strong> <span id="phAnalysisValue">--</span> | <strong>Current DO:</strong> <span id="doAnalysisValue">-- mg/L</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Pattern Recognition Section -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-title"><i class="fas fa-brain"></i> Pattern Recognition & Interpretation</div>
                    <div class="analysis-box">
                        <h4><i class="fas fa-search"></i> What Intersections Tell Us:</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px;">
                                <h5 style="color: #1565c0; margin-bottom: 0.5rem;">
                                    <i class="fas fa-thermometer-full"></i> High Temp + High Turbidity
                                </h5>
                                <p style="font-size: 0.9rem;">Indicates warm, sediment-rich water - common in tropical ballast water from ports near river deltas.</p>
                            </div>
                            
                            <div style="background: #f3e5f5; padding: 1rem; border-radius: 8px;">
                                <h5 style="color: #7b1fa2; margin-bottom: 0.5rem;">
                                    <i class="fas fa-bolt"></i> High Conductivity + Low DO
                                </h5>
                                <p style="font-size: 0.9rem;">Suggests saline, oxygen-depleted water - typical of ballast from deep ocean or enclosed port areas.</p>
                            </div>
                            
                            <div style="background: #e8f5e9; padding: 1rem; border-radius: 8px;">
                                <h5 style="color: #2e7d32; margin-bottom: 0.5rem;">
                                    <i class="fas fa-vial"></i> pH Shift + Turbidity Spike
                                </h5>
                                <p style="font-size: 0.9rem;">Chemical change with particulate matter - indicates ballast water with different mineral content.</p>
                            </div>
                            
                            <div style="background: #fff3e0; padding: 1rem; border-radius: 8px;">
                                <h5 style="color: #f57c00; margin-bottom: 0.5rem;">
                                    <i class="fas fa-exclamation-triangle"></i> 3+ Threshold Crossings
                                </h5>
                                <p style="font-size: 0.9rem;"><strong>HIGH PROBABILITY</strong> of ballast water presence. Multiple parameter deviations confirm foreign water contamination.</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 1rem; background: #fff8e1; border-radius: 8px; border-left: 4px solid #ff9800;">
                            <h5 style="color: #ff6f00; margin-bottom: 0.5rem;">
                                <i class="fas fa-clock"></i> Temporal Analysis
                            </h5>
                            <p style="font-size: 0.9rem;"><strong>Key Timing Indicators:</strong></p>
                            <ul style="padding-left: 1.5rem; font-size: 0.9rem;">
                                <li>Simultaneous parameter changes indicate immediate contamination</li>
                                <li>Gradual changes over hours suggest mixing/diffusion</li>
                                <li>Cyclic patterns may indicate tidal influence vs. contamination</li>
                                <li>Time-correlated spikes match ship discharge events</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Maps Section -->
            <div id="mapsSection" class="dashboard-section">
                <h2 class="section-title">
                    <i class="fas fa-map"></i>
                    Maps & GPS Tracking
                </h2>
                
                <div class="card">
                    <div class="card-title"><i class="fas fa-satellite"></i> Drone Path Tracking & Live Camera</div>
                    <div class="map-camera-grid">
                        <div class="map-container" id="trackingMap"></div>
                        <div class="camera-container">
                            <img src="/video_feed" class="camera-feed" alt="Drone Camera Feed">
                            <div class="camera-overlay">
                                <i class="fas fa-camera"></i>
                                <span id="cameraFeedStatus2">Live</span>
                                <span id="cameraType2">(USB Webcam)</span>
                            </div>
                        </div>
                    </div>
                    <div class="time-controls" style="margin-top: 1rem;">
                        <button class="action-btn" onclick="clearPath()">
                            <i class="fas fa-trash"></i> Clear Path
                        </button>
                        <button class="action-btn" onclick="exportPath()">
                            <i class="fas fa-download"></i> Export Path
                        </button>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem;">
                            <div class="status-indicator">
                                <div class="indicator-dot connected" id="mapStatusDot"></div>
                                <span>Tracking: <span id="trackingStatus">Active</span></span>
                            </div>
                            <div id="distanceTraveled">Distance: 0 m</div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid" style="margin-top: 1.5rem;">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-location-arrow"></i> GPS Information</div>
                        <div style="margin-top: 1rem;">
                            <table class="stats-table">
                                <tbody>
                                    <tr>
                                        <td>Latitude</td>
                                        <td id="gpsLatitude">--</td>
                                    </tr>
                                    <tr>
                                        <td>Longitude</td>
                                        <td id="gpsLongitude">--</td>
                                    </tr>
                                    <tr>
                                        <td>Altitude</td>
                                        <td id="gpsAltitude">-- m</td>
                                    </tr>
                                    <tr>
                                        <td>Speed</td>
                                        <td id="gpsSpeed">-- m/s</td>
                                    </tr>
                                    <tr>
                                        <td>Heading</td>
                                        <td id="gpsHeading">--°</td>
                                    </tr>
                                    <tr>
                                        <td>Satellites</td>
                                        <td id="gpsSatellites">--</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title"><i class="fas fa-history"></i> Path History</div>
                        <div class="chart-container">
                            <canvas id="pathHistoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistics Section -->
            <div id="statisticsSection" class="dashboard-section">
                <h2 class="section-title">
                    <i class="fas fa-chart-pie"></i>
                    Statistical Analysis
                </h2>
                
                <div class="time-controls">
                    <span>Analysis Period:</span>
                    <select id="statsPeriod" onchange="loadStatistics()" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="1">Last 24 Hours</option>
                        <option value="7" selected>Last 7 Days</option>
                        <option value="30">Last 30 Days</option>
                        <option value="90">Last 3 Months</option>
                        <option value="365">Last Year</option>
                    </select>
                </div>
                
                <div id="statisticsContent">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Debug & Logs Section -->
            <div id="debugSection" class="dashboard-section">
                <h2 class="section-title">
                    <i class="fas fa-bug"></i>
                    System Debug & Logs
                </h2>
                
                <div class="debug-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-plug"></i> Connection Status</div>
                        <div class="status-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); margin-top: 1rem;">
                            <div class="status-item">
                                <div class="status-label">Drone Connection</div>
                                <div class="status-value" id="debugDroneStatus">Disconnected</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Camera Status</div>
                                <div class="status-value" id="debugCameraStatus">Not Initialized</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Reconnect Attempts</div>
                                <div class="status-value" id="debugReconnectAttempts">0</div>
                            </div>
                            <div class="status-item">
                                <div class="status-label">Serial Port</div>
                                <div class="status-value" id="debugSerialPort">COM4</div>
                            </div>
                        </div>
                        
                        <div class="time-controls" style="margin-top: 1rem;">
                            <button class="action-btn" onclick="reconnectDrone()">
                                <i class="fas fa-plug"></i> Reconnect Drone
                            </button>
                            <button class="action-btn" onclick="reconnectCamera()">
                                <i class="fas fa-camera"></i> Reconnect Camera
                            </button>
                            <button class="action-btn" onclick="refreshDebugInfo()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title"><i class="fas fa-history"></i> Last Data Received</div>
                        <div id="lastDataReceived" style="padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-top: 1rem; font-family: monospace;">
                            No data received yet
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title"><i class="fas fa-file-alt"></i> System Logs</div>
                    
                    <div class="time-controls">
                        <select id="logLevel" onchange="loadSystemLogs()" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">All Levels</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="critical">Critical</option>
                        </select>
                        <select id="logSource" onchange="loadSystemLogs()" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">All Sources</option>
                            <option value="drone">Drone</option>
                            <option value="buoy">Buoy</option>
                            <option value="camera">Camera</option>
                            <option value="system">System</option>
                        </select>
                        <button class="action-btn" onclick="loadSystemLogs()">
                            <i class="fas fa-sync-alt"></i> Refresh Logs
                        </button>
                        <button class="action-btn" onclick="exportLogs()">
                            <i class="fas fa-download"></i> Export Logs
                        </button>
                    </div>
                    
                    <div class="log-table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; margin-top: 1rem;">
                        <table class="log-table" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="background: var(--primary); color: white; padding: 0.8rem 1rem; text-align: left; position: sticky; top: 0;">Timestamp</th>
                                    <th style="background: var(--primary); color: white; padding: 0.8rem 1rem; text-align: left; position: sticky; top: 0;">Source</th>
                                    <th style="background: var(--primary); color: white; padding: 0.8rem 1rem; text-align: left; position: sticky; top: 0;">Level</th>
                                    <th style="background: var(--primary); color: white; padding: 0.8rem 1rem; text-align: left; position: sticky; top: 0;">Message</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody">
                                <!-- Logs will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Export Section -->
            <div id="exportSection" class="dashboard-section">
                <h2 class="section-title">
                    <i class="fas fa-download"></i>
                    Data Export
                </h2>
                
                <div class="card">
                    <div class="card-title"><i class="fas fa-database"></i> Export Configuration</div>
                    
                    <div class="export-controls">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Time Range:</label>
                            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                                <input type="date" id="exportStartDate" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <span>to</span>
                                <input type="date" id="exportEndDate" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <button class="time-btn" onclick="setExportDateRange(7)">Last 7 Days</button>
                                <button class="time-btn" onclick="setExportDateRange(30)">Last 30 Days</button>
                                <button class="time-btn" onclick="setExportDateRange(365)">Last Year</button>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Format:</label>
                            <select id="exportFormat" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <button class="action-btn" onclick="exportDroneData()" style="padding: 0.8rem 1.5rem; font-size: 1rem;">
                            <i class="fas fa-download"></i> Export Drone Data
                        </button>
                    </div>
                </div>
            </div>
        </div> <!-- close main-content -->
    </div> <!-- close dashboard-container -->

    <!-- Footer placed outside dashboard-container for proper page footer -->
    <div class="dashboard-footer">
        <p>
            <strong>ATAWI-3A3 | Drone Water Analysis System | Real-time Monitoring Dashboard</strong>
        </p>
        <p>
            Data updates every 2 seconds | System status: <span id="systemStatus" style="color:#4CAF50;">Operational</span>
        </p>
        <div class="copyright-info">
            <p>
                <i class="fas fa-copyright"></i>
                Powered by<strong> Sparte Robotics</strong> | All Rights Reserved | Copyright 2025
            </p>
        </div>
    </div>

    <script>
        // ==================== FIXED REAL-TIME UPDATES ====================
        // Global variables
        let charts = {};
        let droneMap = null;
        let trackingMap = null;
        let droneMarker = null;
        // Path layers for both maps
        let dronePathLayer = null;      // path on overview map
        let trackingPathLayer = null;   // path on tracking map
        let pathCoordinates = [];
        let startTime = new Date();
        let currentTimeRange = 24;
        let updateInterval;
        let ballastDetectionHistory = [];
        let timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        let simulatedData = [];
        let ballastCertainty = 0;

        // Douala bounding box for fallback simulation (approx 800 km²)
        const DOUALA_BBOX = {
            lat_min: 3.8,
            lat_max: 4.3,
            lon_min: 9.5,
            lon_max: 10.0
        };
        // Drone movement for fallback (same as backend)
        let drone_target_lat = 4.05;
        let drone_target_lon = 9.77;
        const drone_move_step = 0.0005;  // degrees per step (~55 meters)

        // Sensor thresholds for simulation
        const thresholds = {
            temperature: 32,
            turbidity: 41,
            conductivity: 12,
            ph_low: 6.5,
            ph_high: 7.5,
            do: 5
        };
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Set username
            document.getElementById('username').textContent = "{{ current_user.username }}";
            
            // Setup navigation
            setupNavigation();
            
            // Setup dashboard switcher
            setupDashboardSwitcher();
            
            // Initialize maps (overview + tracking) centered on Douala with higher zoom
            initMaps();
            initTrackingMap(); // create tracking map early so path is recorded
            
            // Display timezone
            document.getElementById('timezoneDisplay').textContent = timezone;
            
            // Initialize simulated data
            initializeSimulatedData();
            
            // Load initial data
            loadRealTimeData();         // immediate call
            loadQuickStats();
            loadTimeSeriesData(24, null);
            loadSystemLogs();
            loadRecentAlerts();
            
            // Start periodic updates – every 3 seconds
            updateInterval = setInterval(() => {
                loadRealTimeData();      // updates sensor cards + triggers chart updates
                loadQuickStats();
                loadRecentAlerts();
            }, 3000);
            
            // Update sidebar clock every second
            setInterval(updateSidebarTime, 1000);
            
            // Update uptime every second
            setInterval(updateUptime, 1000);
            
            // Load debug info on start
            loadDebugInfo();
        });
        
        // Setup dashboard switcher
        function setupDashboardSwitcher() {
            const selector = document.getElementById('dashboardSelector');
            selector.addEventListener('change', function() {
                if (this.value === 'buoy') {
                    window.location.href = '/buoy-dashboard';
                } else {
                    window.location.href = '/dashboard';
                }
            });
        }
        
        // Setup navigation
        function setupNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            
            navButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    navButtons.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Hide all sections
                    document.querySelectorAll('.dashboard-section').forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    // Show selected section
                    const sectionId = this.dataset.section + 'Section';
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Load section-specific data
                    switch(this.dataset.section) {
                        case 'graphs':
                            loadTimeSeriesData(currentTimeRange, null);
                            break;
                        case 'maps':
                            // tracking map already exists, but ensure it's visible
                            if (trackingMap) setTimeout(() => trackingMap.invalidateSize(), 100);
                            break;
                        case 'statistics':
                            loadStatistics();
                            break;
                        case 'debug':
                            loadDebugInfo();
                            loadSystemLogs();
                            break;
                    }
                });
            });
        }
        
        // Initialize simulated data with random walk inside Douala bounding box
        function initializeSimulatedData() {
            simulatedData = [];
            const now = new Date();
            let lat = 4.05, lon = 9.77; // start near Douala
            for (let i = 0; i < 100; i++) {
                const timestamp = new Date(now.getTime() - (100 - i) * 3000);
                // Move a little for each historical point (smooth path)
                let dlat = drone_target_lat - lat;
                let dlon = drone_target_lon - lon;
                let dist = Math.sqrt(dlat*dlat + dlon*dlon);
                if (dist < drone_move_step * 1.5) {
                    drone_target_lat = Math.random() * (DOUALA_BBOX.lat_max - DOUALA_BBOX.lat_min) + DOUALA_BBOX.lat_min;
                    drone_target_lon = Math.random() * (DOUALA_BBOX.lon_max - DOUALA_BBOX.lon_min) + DOUALA_BBOX.lon_min;
                } else {
                    let step = Math.min(drone_move_step, dist);
                    lat += step * (dlat / dist);
                    lon += step * (dlon / dist);
                }
                // Clamp
                lat = Math.max(DOUALA_BBOX.lat_min, Math.min(DOUALA_BBOX.lat_max, lat));
                lon = Math.max(DOUALA_BBOX.lon_min, Math.min(DOUALA_BBOX.lon_max, lon));
                
                let temperature = 28 + Math.random() * 4;
                let turbidity = 30 + Math.random() * 15;
                let conductivity = 8 + Math.random() * 5;
                let ph = 6.8 + Math.random() * 0.9;
                let doValue = 4.5 + Math.random() * 3;
                
                if (Math.random() < 0.2) {
                    temperature = 33 + Math.random() * 3;
                    turbidity = 45 + Math.random() * 15;
                    conductivity = 13 + Math.random() * 5;
                    ph = 6.0 + Math.random() * 0.5;
                    if (Math.random() > 0.5) ph = 7.8 + Math.random() * 0.4;
                    doValue = 3 + Math.random() * 2;
                }

                simulatedData.push({
                    timestamp: timestamp,
                    temperature: parseFloat(temperature.toFixed(2)),
                    turbidity: parseFloat(turbidity.toFixed(2)),
                    conductivity: parseFloat(conductivity.toFixed(2)),
                    ph: parseFloat(ph.toFixed(2)),
                    do: parseFloat(doValue.toFixed(2)),
                    latitude: lat,
                    longitude: lon,
                    battery: 85 - Math.random() * 5,
                    connected: true
                });
            }
        }
        
        // Generate a simulated data point (fallback when API fails) – now with Douala random walk
        function generateSimulatedDataPoint(timestamp) {
            // Get current position from global (or from last known)
            let lat = (simulatedData.length > 0) ? simulatedData[simulatedData.length-1].latitude : 4.05;
            let lon = (simulatedData.length > 0) ? simulatedData[simulatedData.length-1].longitude : 9.77;
            
            // Move toward target
            let dlat = drone_target_lat - lat;
            let dlon = drone_target_lon - lon;
            let dist = Math.sqrt(dlat*dlat + dlon*dlon);
            if (dist < drone_move_step * 1.5) {
                drone_target_lat = Math.random() * (DOUALA_BBOX.lat_max - DOUALA_BBOX.lat_min) + DOUALA_BBOX.lat_min;
                drone_target_lon = Math.random() * (DOUALA_BBOX.lon_max - DOUALA_BBOX.lon_min) + DOUALA_BBOX.lon_min;
            } else {
                let step = Math.min(drone_move_step, dist);
                lat += step * (dlat / dist);
                lon += step * (dlon / dist);
            }
            // Clamp
            lat = Math.max(DOUALA_BBOX.lat_min, Math.min(DOUALA_BBOX.lat_max, lat));
            lon = Math.max(DOUALA_BBOX.lon_min, Math.min(DOUALA_BBOX.lon_max, lon));

            let temperature = 28 + Math.random() * 4;
            let turbidity = 30 + Math.random() * 15;
            let conductivity = 8 + Math.random() * 5;
            let ph = 6.8 + Math.random() * 0.9;
            let doValue = 4.5 + Math.random() * 3;
            
            if (Math.random() < 0.2) {
                temperature = 33 + Math.random() * 3;
                turbidity = 45 + Math.random() * 15;
                conductivity = 13 + Math.random() * 5;
                ph = 6.0 + Math.random() * 0.5;
                if (Math.random() > 0.5) ph = 7.8 + Math.random() * 0.4;
                doValue = 3 + Math.random() * 2;
            }

            return {
                timestamp: timestamp,
                temperature: parseFloat(temperature.toFixed(2)),
                turbidity: parseFloat(turbidity.toFixed(2)),
                conductivity: parseFloat(conductivity.toFixed(2)),
                ph: parseFloat(ph.toFixed(2)),
                do: parseFloat(doValue.toFixed(2)),
                latitude: lat,
                longitude: lon,
                battery: 85 - Math.random() * 5,
                connected: true
            };
        }
        
        // Update sidebar time
        function updateSidebarTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false,
                timeZone: timezone
            });
            document.getElementById('sidebarTime').textContent = timeString;
        }
        
        // Update uptime
        function updateUptime() {
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;
            document.getElementById('uptimeValue').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Initialize overview map – centered on Douala with higher zoom
        function initMaps() {
            // Overview map
            droneMap = L.map('droneMap').setView([4.05, 9.77], 12); // zoom 12 to see movement
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(droneMap);
            droneMarker = L.marker([4.05, 9.77]).addTo(droneMap)
                .bindPopup('Drone Position')
                .openPopup();
            // Create a polyline for the overview map (initially empty)
            dronePathLayer = L.polyline([], { color: 'blue', weight: 3, opacity: 0.7 }).addTo(droneMap);
            L.control.scale().addTo(droneMap);
        }
        
        // Initialize tracking map – centered on Douala with higher zoom
        function initTrackingMap() {
            // If already exists, just return
            if (trackingMap) return;
            
            trackingMap = L.map('trackingMap').setView([4.05, 9.77], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(trackingMap);
            trackingPathLayer = L.polyline([], { color: 'blue', weight: 3, opacity: 0.7 }).addTo(trackingMap);
            L.control.scale().addTo(trackingMap);
        }
        
        // ---------------------- REAL-TIME DATA FETCH ----------------------
        function loadRealTimeData() {
            fetch('/api/drone/real-time', { credentials: 'include' })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    const newData = {
                        timestamp: new Date(),
                        temperature: data.temperature ?? 0,
                        turbidity: data.turbidity ?? 0,
                        conductivity: data.conductivity ?? 0,
                        ph: data.ph ?? 7.0,
                        do: data.do ?? 5.0,
                        latitude: data.latitude ?? 4.05,
                        longitude: data.longitude ?? 9.77,
                        battery: data.battery ?? 85,
                        connected: data.connected ?? true
                    };
                    
                    simulatedData.push(newData);
                    if (simulatedData.length > 200) simulatedData.shift();
                    
                    updateSensorDisplay(newData);
                    updateConnectionStatus(newData);
                    checkThresholds(newData);
                    updateMap(newData);
                    updateQuickTrends(newData);
                    updateBallastDetection(newData);
                    updateAnalysisValues(newData);
                    
                    updateAllCharts();
                    
                    const now = new Date();
                    const localTime = now.toLocaleTimeString('en-US', { timeZone: timezone, hour12: false });
                    document.getElementById('lastUpdateTime').textContent = `Last update: ${localTime}`;
                })
                .catch(error => {
                    console.error('Error fetching real-time data:', error);
                    // Fallback to simulation
                    const newData = generateSimulatedDataPoint(new Date());
                    simulatedData.push(newData);
                    if (simulatedData.length > 200) simulatedData.shift();
                    
                    updateSensorDisplay(newData);
                    updateConnectionStatus(newData);
                    checkThresholds(newData);
                    updateMap(newData);
                    updateQuickTrends(newData);
                    updateBallastDetection(newData);
                    updateAnalysisValues(newData);
                    updateAllCharts();
                    
                    const now = new Date();
                    const localTime = now.toLocaleTimeString('en-US', { timeZone: timezone, hour12: false });
                    document.getElementById('lastUpdateTime').textContent = `Last update: ${localTime} (Simulated)`;
                });
        }
        
        // ---------------------- CHART UPDATES (SAFE) ----------------------
        function updateAllCharts() {
            try {
                if (charts.timeSeries) updateTimeSeriesChart();
                if (charts.temperature) updateIndividualCharts();
                if (charts.phDo) updatePHDOChart();
                updateGraphAnalysis();
            } catch (e) {
                console.error('Error updating charts:', e);
            }
        }
        
        // Helper to safely format numbers
        function safeToFixed(value, digits, fallback = '--') {
            if (value === null || value === undefined || isNaN(value)) return fallback;
            return value.toFixed(digits);
        }
        
        // Update sensor display
        function updateSensorDisplay(data) {
            document.getElementById('tempValue').textContent = safeToFixed(data.temperature, 2) + ' °C';
            document.getElementById('turbidityValue').textContent = safeToFixed(data.turbidity, 2) + ' NTU';
            document.getElementById('conductivityValue').textContent = safeToFixed(data.conductivity, 2) + ' mS/cm';
            document.getElementById('phValue').textContent = safeToFixed(data.ph, 2);
            document.getElementById('doValue').textContent = safeToFixed(data.do, 2) + ' mg/L';
            document.getElementById('batteryValue').textContent = safeToFixed(data.battery, 0) + '%';
            document.getElementById('batteryStatusText').textContent = safeToFixed(data.battery, 0) + '%';
            
            if (data.latitude && data.longitude) {
                document.getElementById('gpsValue').textContent = `${safeToFixed(data.latitude, 6)}, ${safeToFixed(data.longitude, 6)}`;
                document.getElementById('gpsLatitude').textContent = safeToFixed(data.latitude, 6);
                document.getElementById('gpsLongitude').textContent = safeToFixed(data.longitude, 6);
                document.getElementById('gpsStatus').textContent = 'GPS: Active';
                
                // Simulated extra GPS data
                const speed = Math.random() * 1.5;
                document.getElementById('speedValue').textContent = speed.toFixed(2) + ' m/s';
                document.getElementById('gpsSpeed').textContent = speed.toFixed(2) + ' m/s';
                document.getElementById('gpsHeading').textContent = Math.floor(Math.random() * 360) + '°';
                document.getElementById('gpsSatellites').textContent = Math.floor(Math.random() * 5) + 8;
                document.getElementById('gpsAltitude').textContent = (Math.random() * 2).toFixed(1) + ' m';
            }
            
            if (data.conductivity) {
                const salinity = data.conductivity * 0.64;
                document.getElementById('salinityValue').textContent = safeToFixed(salinity, 2) + ' PSU';
            }
        }
        
        // Update connection status
        function updateConnectionStatus(data) {
            const isConnected = data.connected === true;
            const connectionDot = document.getElementById('connectionDot');
            const connectionStatus = document.getElementById('connectionStatus');
            const droneStatusDot = document.getElementById('droneStatusDot');
            const droneStatusText = document.getElementById('droneStatusText');
            const sidebarStatusDot = document.getElementById('sidebarStatusDot');
            const sidebarStatusText = document.getElementById('sidebarStatusText');
            
            if (isConnected) {
                connectionDot.className = 'indicator-dot connected';
                connectionStatus.textContent = 'Connected';
                droneStatusDot.className = 'indicator-dot connected';
                droneStatusText.textContent = 'Connected';
                sidebarStatusDot.className = 'indicator-dot connected';
                sidebarStatusText.textContent = 'System Online';
            } else {
                connectionDot.className = 'indicator-dot disconnected';
                connectionStatus.textContent = 'Disconnected';
                droneStatusDot.className = 'indicator-dot disconnected';
                droneStatusText.textContent = 'Disconnected';
                sidebarStatusDot.className = 'indicator-dot error';
                sidebarStatusText.textContent = 'Drone Offline';
            }
        }
        
        // Check thresholds and update ballast water detection
        function checkThresholds(data) {
            let exceedCount = 0;
            let alertMessages = [];
            
            let tempProb = 0, turbidityProb = 0, conductivityProb = 0, phProb = 0, doProb = 0;
            
            if (data.temperature > thresholds.temperature) {
                updateSensorStatus('temp', 'alert', `High: ${data.temperature.toFixed(2)}°C`);
                document.getElementById('thresholdTemp').classList.add('exceeded');
                document.getElementById('thresholdTempStatus').textContent = 'EXCEEDED';
                document.getElementById('thresholdTempStatus').style.color = '#f44336';
                exceedCount++;
                alertMessages.push(`Temperature (${data.temperature.toFixed(2)}°C)`);
                tempProb = calculateProbability(data.temperature, thresholds.temperature, 40);
            } else {
                updateSensorStatus('temp', 'normal');
                document.getElementById('thresholdTemp').classList.remove('exceeded');
                document.getElementById('thresholdTempStatus').textContent = 'Normal';
                document.getElementById('thresholdTempStatus').style.color = '#4CAF50';
            }
            
            if (data.turbidity > thresholds.turbidity) {
                updateSensorStatus('turbidity', 'alert', `High: ${data.turbidity.toFixed(2)} NTU`);
                document.getElementById('thresholdTurbidity').classList.add('exceeded');
                document.getElementById('thresholdTurbidityStatus').textContent = 'EXCEEDED';
                document.getElementById('thresholdTurbidityStatus').style.color = '#f44336';
                exceedCount++;
                alertMessages.push(`Turbidity (${data.turbidity.toFixed(2)} NTU)`);
                turbidityProb = calculateProbability(data.turbidity, thresholds.turbidity, 60);
            } else {
                updateSensorStatus('turbidity', 'normal');
                document.getElementById('thresholdTurbidity').classList.remove('exceeded');
                document.getElementById('thresholdTurbidityStatus').textContent = 'Normal';
                document.getElementById('thresholdTurbidityStatus').style.color = '#4CAF50';
            }
            
            if (data.conductivity > thresholds.conductivity) {
                updateSensorStatus('conductivity', 'alert', `High: ${data.conductivity.toFixed(2)} mS/cm`);
                document.getElementById('thresholdConductivity').classList.add('exceeded');
                document.getElementById('thresholdConductivityStatus').textContent = 'EXCEEDED';
                document.getElementById('thresholdConductivityStatus').style.color = '#f44336';
                exceedCount++;
                alertMessages.push(`Conductivity (${data.conductivity.toFixed(2)} mS/cm)`);
                conductivityProb = calculateProbability(data.conductivity, thresholds.conductivity, 20);
            } else {
                updateSensorStatus('conductivity', 'normal');
                document.getElementById('thresholdConductivity').classList.remove('exceeded');
                document.getElementById('thresholdConductivityStatus').textContent = 'Normal';
                document.getElementById('thresholdConductivityStatus').style.color = '#4CAF50';
            }
            
            if (data.ph < thresholds.ph_low || data.ph > thresholds.ph_high) {
                updateSensorStatus('ph', 'alert', `Out of range: ${data.ph.toFixed(2)}`);
                document.getElementById('thresholdPH').classList.add('exceeded');
                document.getElementById('thresholdPHStatus').textContent = 'EXCEEDED';
                document.getElementById('thresholdPHStatus').style.color = '#f44336';
                exceedCount++;
                alertMessages.push(`pH (${data.ph.toFixed(2)})`);
                phProb = calculateProbability(data.ph, thresholds.ph_low, thresholds.ph_high, true);
            } else {
                updateSensorStatus('ph', 'normal');
                document.getElementById('thresholdPH').classList.remove('exceeded');
                document.getElementById('thresholdPHStatus').textContent = 'Normal';
                document.getElementById('thresholdPHStatus').style.color = '#4CAF50';
            }
            
            if (data.do < thresholds.do) {
                updateSensorStatus('do', 'alert', `Low: ${data.do.toFixed(2)} mg/L`);
                document.getElementById('thresholdDO').classList.add('exceeded');
                document.getElementById('thresholdDOStatus').textContent = 'EXCEEDED';
                document.getElementById('thresholdDOStatus').style.color = '#f44336';
                exceedCount++;
                alertMessages.push(`Dissolved Oxygen (${data.do.toFixed(2)} mg/L)`);
                doProb = calculateProbability(data.do, thresholds.do, 0, false, true);
            } else {
                updateSensorStatus('do', 'normal');
                document.getElementById('thresholdDO').classList.remove('exceeded');
                document.getElementById('thresholdDOStatus').textContent = 'Normal';
                document.getElementById('thresholdDOStatus').style.color = '#4CAF50';
            }
            
            updateThresholdIndicators('temp', data.temperature > thresholds.temperature);
            updateThresholdIndicators('turbidity', data.turbidity > thresholds.turbidity);
            updateThresholdIndicators('ph', data.ph < thresholds.ph_low || data.ph > thresholds.ph_high);
            updateThresholdIndicators('do', data.do < thresholds.do);
            updateThresholdIndicators('conductivity', data.conductivity > thresholds.conductivity);
            
            if (exceedCount >= 3) {
                document.getElementById('alertMessage').textContent = 
                    `Ballast water detected! ${exceedCount} sensors exceeding thresholds: ${alertMessages.join(', ')}`;
                document.getElementById('alertBanner').style.display = 'block';
            } else {
                document.getElementById('alertBanner').style.display = 'none';
            }
            
            ballastDetectionHistory.push({
                timestamp: new Date(),
                exceedCount: exceedCount,
                temperature: data.temperature,
                turbidity: data.turbidity,
                conductivity: data.conductivity,
                ph: data.ph,
                do: data.do
            });
            if (ballastDetectionHistory.length > 100) ballastDetectionHistory.shift();
            
            document.getElementById('probTemp').textContent = tempProb.toFixed(0) + '%';
            document.getElementById('probTurbidity').textContent = turbidityProb.toFixed(0) + '%';
            document.getElementById('probConductivity').textContent = conductivityProb.toFixed(0) + '%';
            document.getElementById('probPH').textContent = phProb.toFixed(0) + '%';
            document.getElementById('probDO').textContent = doProb.toFixed(0) + '%';
        }
        
        function calculateProbability(value, threshold, maxValue, isRange = false, isLowerThreshold = false) {
            if (isRange) {
                const midPoint = (threshold + maxValue) / 2;
                const range = maxValue - threshold;
                const deviation = Math.abs(value - midPoint);
                return Math.min(100, Math.max(0, (deviation / (range / 2)) * 100));
            } else if (isLowerThreshold) {
                if (value >= threshold) return 0;
                const deviation = threshold - value;
                return Math.min(100, (deviation / threshold) * 200);
            } else {
                if (value <= threshold) return 0;
                const deviation = value - threshold;
                const maxDeviation = maxValue - threshold;
                return Math.min(100, (deviation / maxDeviation) * 100);
            }
        }
        
        function updateSensorStatus(sensor, status, message = '') {
            const element = document.getElementById(sensor + 'Status');
            element.className = `sensor-status status-${status}`;
            if (status === 'alert') element.textContent = message || 'Alert';
            else if (status === 'warning') element.textContent = 'Warning';
            else element.textContent = 'Normal';
        }
        
        function updateThresholdIndicators(sensor, isExceeded) {
            const indicator = document.getElementById(sensor + 'ThresholdIndicator');
            const card = document.querySelector(`.${sensor}-card`);
            if (indicator) indicator.style.display = isExceeded ? 'block' : 'none';
            if (card) {
                if (isExceeded) card.classList.add('alert');
                else card.classList.remove('alert');
            }
        }
        
        function updateBallastDetection(data) {
            const ballastIndicator = document.getElementById('ballastStatus');
            const certaintyPercentage = document.getElementById('certaintyPercentage');
            const certaintyFill = document.getElementById('certaintyFill');
            const certaintyText = document.getElementById('certaintyText');
            
            let exceedCount = 0;
            if (data.temperature > thresholds.temperature) exceedCount++;
            if (data.turbidity > thresholds.turbidity) exceedCount++;
            if (data.conductivity > thresholds.conductivity) exceedCount++;
            if (data.ph < thresholds.ph_low || data.ph > thresholds.ph_high) exceedCount++;
            if (data.do < thresholds.do) exceedCount++;
            
            let certainty = 0;
            if (exceedCount >= 5) certainty = 95 + Math.random() * 5;
            else if (exceedCount === 4) certainty = 85 + Math.random() * 10;
            else if (exceedCount === 3) certainty = 70 + Math.random() * 15;
            else if (exceedCount === 2) certainty = 40 + Math.random() * 20;
            else if (exceedCount === 1) certainty = 20 + Math.random() * 15;
            else certainty = Math.random() * 15;
            
            certainty += (Math.random() - 0.5) * 10;
            certainty = Math.max(0, Math.min(100, certainty));
            ballastCertainty = certainty;
            
            if (certainty >= 70) {
                ballastIndicator.className = 'ballast-indicator detected';
                ballastIndicator.innerHTML = `<i class="fas fa-exclamation-triangle"></i> BALLAST WATER DETECTED! (${certainty.toFixed(0)}% certainty)`;
                document.getElementById('graphAnalysisText').innerHTML = 
                    `<span style="color: #f44336; font-weight: bold;">⚠️ HIGH PROBABILITY (${certainty.toFixed(0)}%) of Ballast Water!</span> ` + 
                    exceedCount + ' sensors exceeding thresholds indicates high probability of ballast water contamination.';
            } else if (certainty >= 30) {
                ballastIndicator.className = 'ballast-indicator suspected';
                ballastIndicator.innerHTML = `<i class="fas fa-exclamation-circle"></i> SUSPECTED Ballast Water (${certainty.toFixed(0)}% certainty)`;
                document.getElementById('graphAnalysisText').innerHTML = 
                    `<span style="color: #FF9800; font-weight: bold;">⚠️ MODERATE PROBABILITY (${certainty.toFixed(0)}%) of Contamination</span> ` + 
                    exceedCount + ' sensors showing abnormal readings indicates possible ballast water presence.';
            } else {
                ballastIndicator.className = 'ballast-indicator normal';
                ballastIndicator.innerHTML = `<i class="fas fa-check-circle"></i> No Ballast Water Detected (${certainty.toFixed(0)}% certainty)`;
                document.getElementById('graphAnalysisText').textContent = 
                    `Normal conditions (${certainty.toFixed(0)}% certainty). All parameters within acceptable ranges.`;
            }
            
            certaintyPercentage.textContent = certainty.toFixed(0) + '%';
            certaintyPercentage.className = 'certainty-percentage';
            if (certainty >= 70) {
                certaintyPercentage.classList.add('high');
                certaintyFill.className = 'certainty-fill high';
            } else if (certainty >= 30) {
                certaintyPercentage.classList.add('medium');
                certaintyFill.className = 'certainty-fill medium';
            } else {
                certaintyPercentage.classList.add('low');
                certaintyFill.className = 'certainty-fill low';
            }
            certaintyFill.style.width = certainty + '%';
            certaintyText.textContent = certainty.toFixed(0) + '% Certainty';
        }
        
        function updateAnalysisValues(data) {
            document.getElementById('tempAnalysisValue').textContent = safeToFixed(data.temperature, 2) + '°C';
            document.getElementById('turbidityAnalysisValue').textContent = safeToFixed(data.turbidity, 2) + ' NTU';
            document.getElementById('conductivityAnalysisValue').textContent = safeToFixed(data.conductivity, 2) + ' mS/cm';
            document.getElementById('phAnalysisValue').textContent = safeToFixed(data.ph, 2);
            document.getElementById('doAnalysisValue').textContent = safeToFixed(data.do, 2) + ' mg/L';
        }
        
        function updateMap(data) {
            if (data.latitude && data.longitude && droneMap && droneMarker) {
                const newLatLng = [data.latitude, data.longitude];
                droneMarker.setLatLng(newLatLng);
                // Do NOT recenter the overview map automatically
                
                // Append to path coordinates
                pathCoordinates.push(newLatLng);
                
                // Update path on overview map if it exists
                if (dronePathLayer) {
                    dronePathLayer.setLatLngs(pathCoordinates);
                }
                
                // Update path on tracking map if it exists
                if (trackingMap && trackingPathLayer) {
                    trackingPathLayer.setLatLngs(pathCoordinates);
                    
                    // Calculate distance (optional)
                    if (pathCoordinates.length > 1) {
                        let totalDistance = 0;
                        for (let i = 1; i < pathCoordinates.length; i++) {
                            const lat1 = pathCoordinates[i-1][0], lon1 = pathCoordinates[i-1][1];
                            const lat2 = pathCoordinates[i][0], lon2 = pathCoordinates[i][1];
                            const R = 6371000;
                            const φ1 = lat1 * Math.PI/180, φ2 = lat2 * Math.PI/180;
                            const Δφ = (lat2-lat1) * Math.PI/180, Δλ = (lon2-lon1) * Math.PI/180;
                            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                                    Math.cos(φ1) * Math.cos(φ2) *
                                    Math.sin(Δλ/2) * Math.sin(Δλ/2);
                            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                            totalDistance += R * c;
                        }
                        document.getElementById('distanceTraveled').textContent = `Distance: ${totalDistance.toFixed(0)} m`;
                    }
                }
            }
        }
        
        // Quick statistics and tables
        async function loadQuickStats() {
            try {
                const stats = {
                    temperature: { mean: 29.5, max: 35.2 },
                    turbidity: { mean: 38.7, max: 58.3 },
                    conductivity: { mean: 10.2, max: 16.8 },
                    ph: { mean: 7.1, max: 8.2 },
                    do: { mean: 5.8, max: 8.5 }
                };
                updateQuickStatsTable(stats);
                updateDataPoints(simulatedData.length);
            } catch (error) {
                console.error('Error loading quick stats:', error);
            }
        }
        
        function updateQuickStatsTable(stats) {
            const tbody = document.getElementById('quickStatsBody');
            tbody.innerHTML = '';
            const sensors = [
                { key: 'temperature', name: 'Temperature', unit: '°C' },
                { key: 'turbidity', name: 'Turbidity', unit: 'NTU' },
                { key: 'conductivity', name: 'Conductivity', unit: 'mS/cm' },
                { key: 'ph', name: 'pH Level', unit: '' },
                { key: 'do', name: 'Dissolved Oxygen', unit: 'mg/L' }
            ];
            sensors.forEach(sensor => {
                if (stats[sensor.key]) {
                    const currentValue = getCurrentValue(sensor.key);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${sensor.name}</td>
                        <td>${currentValue}</td>
                        <td>${stats[sensor.key].mean.toFixed(2)}${sensor.unit}</td>
                        <td>${stats[sensor.key].max.toFixed(2)}${sensor.unit}</td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }
        
        function getCurrentValue(sensor) {
            if (simulatedData.length === 0) return '--';
            const latest = simulatedData[simulatedData.length - 1];
            switch(sensor) {
                case 'temperature': return safeToFixed(latest.temperature, 2);
                case 'turbidity': return safeToFixed(latest.turbidity, 2);
                case 'conductivity': return safeToFixed(latest.conductivity, 2);
                case 'ph': return safeToFixed(latest.ph, 2);
                case 'do': return safeToFixed(latest.do, 2);
                default: return '--';
            }
        }
        
        function updateDataPoints(count) {
            document.getElementById('dataPointsCount').textContent = count;
        }
        
        // Quick trends chart
        function updateQuickTrends(data) {
            if (!charts.quickTrends) {
                const ctx = document.getElementById('quickTrendsChart').getContext('2d');
                charts.quickTrends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            { label: 'Temperature (°C)', data: [], borderColor: '#f44336', backgroundColor: 'rgba(244, 67, 54, 0.1)', tension: 0.4, borderWidth: 2 },
                            { label: 'Turbidity (NTU)', data: [], borderColor: '#2196f3', backgroundColor: 'rgba(33, 150, 243, 0.1)', tension: 0.4, borderWidth: 2 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' } } }
                });
            }
            
            const recentData = simulatedData.slice(-20);
            charts.quickTrends.data.labels = recentData.map(d => {
                const date = new Date(d.timestamp);
                return date.toLocaleTimeString('en-US', { timeZone: timezone, hour12: false, minute: '2-digit', second: '2-digit' });
            });
            charts.quickTrends.data.datasets[0].data = recentData.map(d => d.temperature);
            charts.quickTrends.data.datasets[1].data = recentData.map(d => d.turbidity);
            charts.quickTrends.update();
        }
        
        // Recent alerts
        async function loadRecentAlerts() {
            try {
                let alerts = [];
                if (ballastCertainty >= 70) {
                    alerts = [{
                        id: 1,
                        message: `High probability (${ballastCertainty.toFixed(0)}%) of ballast water contamination detected`,
                        system_type: 'drone',
                        timestamp: new Date().toISOString()
                    }];
                } else if (ballastCertainty >= 30) {
                    alerts = [{
                        id: 1,
                        message: `Moderate probability (${ballastCertainty.toFixed(0)}%) of potential contamination`,
                        system_type: 'drone',
                        timestamp: new Date().toISOString()
                    }];
                }
                document.getElementById('alertsCount').textContent = alerts.length;
                const container = document.getElementById('recentAlertsContent');
                const card = document.getElementById('recentAlertsCard');
                if (alerts.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No recent alerts</div>';
                    card.classList.remove('alert');
                } else {
                    container.innerHTML = '';
                    alerts.forEach(alert => {
                        const div = document.createElement('div');
                        div.style.padding = '0.8rem'; div.style.borderBottom = '1px solid #eee'; div.style.display = 'flex'; div.style.justifyContent = 'space-between'; div.style.alignItems = 'center';
                        const date = new Date(alert.timestamp);
                        const timeStr = date.toLocaleTimeString('en-US', { timeZone: timezone, hour12: false });
                        div.innerHTML = `
                            <div>
                                <div style="font-weight: 500; color: #333;">${alert.message}</div>
                                <div style="font-size: 0.8rem; color: #666;">${timeStr} | ${alert.system_type}</div>
                            </div>
                            <button class="action-btn" onclick="resolveAlert(${alert.id})" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">
                                <i class="fas fa-check"></i> Resolve
                            </button>
                        `;
                        container.appendChild(div);
                    });
                    card.classList.add('alert');
                }
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }
        
        async function resolveAlert(alertId) {
            loadRecentAlerts();
        }
        
        // Time series charts – now accepts optional event parameter
        function loadTimeSeriesData(hours, evt) {
            currentTimeRange = hours;
            if (evt && evt.target) {
                document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('active'));
                evt.target.classList.add('active');
            }
            createTimeSeriesChart();
            createIndividualCharts();
            createPHDOChart();
            updateGraphAnalysis();
        }
        
        function createTimeSeriesChart() {
            const ctx = document.getElementById('timeSeriesChart').getContext('2d');
            if (charts.timeSeries) charts.timeSeries.destroy();
            
            let dataPoints = simulatedData;
            if (currentTimeRange === 1) dataPoints = simulatedData.slice(-60);
            else if (currentTimeRange === 6) dataPoints = simulatedData.slice(-360);
            else if (currentTimeRange === 24) dataPoints = simulatedData.slice(-1440);
            else if (currentTimeRange === 168) dataPoints = simulatedData.slice(-10080);
            else if (currentTimeRange === 720) dataPoints = simulatedData;
            
            const timeLabels = dataPoints.map(d => new Date(d.timestamp));
            const tempData = dataPoints.map(d => d.temperature);
            const turbData = dataPoints.map(d => d.turbidity);
            const condData = dataPoints.map(d => d.conductivity);
            const phData = dataPoints.map(d => d.ph);
            const doData = dataPoints.map(d => d.do);
            
            charts.timeSeries = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        { label: 'Temperature (°C)', data: tempData, borderColor: '#f44336', backgroundColor: 'rgba(244,67,54,0.1)', tension: 0.2, yAxisID: 'y', borderWidth: 2 },
                        { label: 'Temp Threshold (32°C)', data: Array(dataPoints.length).fill(32), borderColor: '#f44336', borderDash: [5,5], pointRadius: 0, yAxisID: 'y' },
                        { label: 'Turbidity (NTU)', data: turbData, borderColor: '#2196f3', backgroundColor: 'rgba(33,150,243,0.1)', tension: 0.2, yAxisID: 'y1', borderWidth: 2 },
                        { label: 'Turbidity Threshold (41 NTU)', data: Array(dataPoints.length).fill(41), borderColor: '#2196f3', borderDash: [5,5], pointRadius: 0, yAxisID: 'y1' },
                        { label: 'Conductivity (mS/cm)', data: condData, borderColor: '#4caf50', backgroundColor: 'rgba(76,175,80,0.1)', tension: 0.2, yAxisID: 'y2', borderWidth: 2 },
                        { label: 'Conductivity Threshold (12 mS/cm)', data: Array(dataPoints.length).fill(12), borderColor: '#4caf50', borderDash: [5,5], pointRadius: 0, yAxisID: 'y2' },
                        { label: 'pH Level', data: phData, borderColor: '#9c27b0', backgroundColor: 'rgba(156,39,176,0.1)', tension: 0.2, yAxisID: 'y3', borderWidth: 2 },
                        { label: 'pH Upper Threshold (7.5)', data: Array(dataPoints.length).fill(7.5), borderColor: '#9c27b0', borderDash: [5,5], pointRadius: 0, yAxisID: 'y3' },
                        { label: 'pH Lower Threshold (6.5)', data: Array(dataPoints.length).fill(6.5), borderColor: '#9c27b0', borderDash: [5,5], pointRadius: 0, yAxisID: 'y3' },
                        { label: 'Dissolved Oxygen (mg/L)', data: doData, borderColor: '#ff9800', backgroundColor: 'rgba(255,152,0,0.1)', tension: 0.2, yAxisID: 'y4', borderWidth: 2 },
                        { label: 'DO Threshold (5 mg/L)', data: Array(dataPoints.length).fill(5), borderColor: '#ff9800', borderDash: [5,5], pointRadius: 0, yAxisID: 'y4' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm', hour: 'HH:mm', day: 'MMM dd' }, tooltipFormat: 'MMM dd, yyyy HH:mm' }, title: { display: true, text: `Time (${timezone})` } },
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Temperature (°C)' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Turbidity (NTU)' }, grid: { drawOnChartArea: false } },
                        y2: { type: 'linear', display: false },
                        y3: { type: 'linear', display: false },
                        y4: { type: 'linear', display: false }
                    }
                }
            });
        }
        
        function updateTimeSeriesChart() {
            if (!charts.timeSeries) return;
            let dataPoints = simulatedData;
            if (currentTimeRange === 1) dataPoints = simulatedData.slice(-60);
            else if (currentTimeRange === 6) dataPoints = simulatedData.slice(-360);
            else if (currentTimeRange === 24) dataPoints = simulatedData.slice(-1440);
            else if (currentTimeRange === 168) dataPoints = simulatedData.slice(-10080);
            else if (currentTimeRange === 720) dataPoints = simulatedData;
            
            charts.timeSeries.data.labels = dataPoints.map(d => new Date(d.timestamp));
            charts.timeSeries.data.datasets[0].data = dataPoints.map(d => d.temperature);
            charts.timeSeries.data.datasets[2].data = dataPoints.map(d => d.turbidity);
            charts.timeSeries.data.datasets[4].data = dataPoints.map(d => d.conductivity);
            charts.timeSeries.data.datasets[6].data = dataPoints.map(d => d.ph);
            charts.timeSeries.data.datasets[9].data = dataPoints.map(d => d.do);
            charts.timeSeries.update();
        }
        
        function createIndividualCharts() {
            let dataPoints = simulatedData;
            if (currentTimeRange === 1) dataPoints = simulatedData.slice(-60);
            else if (currentTimeRange === 6) dataPoints = simulatedData.slice(-360);
            else if (currentTimeRange === 24) dataPoints = simulatedData.slice(-1440);
            else if (currentTimeRange === 168) dataPoints = simulatedData.slice(-10080);
            else if (currentTimeRange === 720) dataPoints = simulatedData;
            
            const timeLabels = dataPoints.map(d => new Date(d.timestamp));
            
            if (charts.temperature) charts.temperature.destroy();
            charts.temperature = createChart('temperatureChart', { label: 'Temperature (°C)', data: dataPoints.map(d => d.temperature), color: '#f44336', threshold: 32 }, timeLabels, 'Temperature (°C)', timezone);
            
            if (charts.turbidity) charts.turbidity.destroy();
            charts.turbidity = createChart('turbidityChart', { label: 'Turbidity (NTU)', data: dataPoints.map(d => d.turbidity), color: '#2196f3', threshold: 41 }, timeLabels, 'Turbidity (NTU)', timezone);
            
            if (charts.conductivity) charts.conductivity.destroy();
            charts.conductivity = createChart('conductivityChart', { label: 'Conductivity (mS/cm)', data: dataPoints.map(d => d.conductivity), color: '#4caf50', threshold: 12 }, timeLabels, 'Conductivity (mS/cm)', timezone);
        }
        
        function updateIndividualCharts() {
            if (!charts.temperature || !charts.turbidity || !charts.conductivity) return;
            let dataPoints = simulatedData;
            if (currentTimeRange === 1) dataPoints = simulatedData.slice(-60);
            else if (currentTimeRange === 6) dataPoints = simulatedData.slice(-360);
            else if (currentTimeRange === 24) dataPoints = simulatedData.slice(-1440);
            else if (currentTimeRange === 168) dataPoints = simulatedData.slice(-10080);
            else if (currentTimeRange === 720) dataPoints = simulatedData;
            
            charts.temperature.data.labels = dataPoints.map(d => new Date(d.timestamp));
            charts.temperature.data.datasets[0].data = dataPoints.map(d => d.temperature);
            charts.turbidity.data.labels = dataPoints.map(d => new Date(d.timestamp));
            charts.turbidity.data.datasets[0].data = dataPoints.map(d => d.turbidity);
            charts.conductivity.data.labels = dataPoints.map(d => new Date(d.timestamp));
            charts.conductivity.data.datasets[0].data = dataPoints.map(d => d.conductivity);
            
            charts.temperature.update();
            charts.turbidity.update();
            charts.conductivity.update();
        }
        
        function createPHDOChart() {
            const ctx = document.getElementById('phDoChart').getContext('2d');
            if (charts.phDo) charts.phDo.destroy();
            
            let dataPoints = simulatedData;
            if (currentTimeRange === 1) dataPoints = simulatedData.slice(-60);
            else if (currentTimeRange === 6) dataPoints = simulatedData.slice(-360);
            else if (currentTimeRange === 24) dataPoints = simulatedData.slice(-1440);
            else if (currentTimeRange === 168) dataPoints = simulatedData.slice(-10080);
            else if (currentTimeRange === 720) dataPoints = simulatedData;
            
            const timeLabels = dataPoints.map(d => new Date(d.timestamp));
            const phData = dataPoints.map(d => d.ph);
            const doData = dataPoints.map(d => d.do);
            
            charts.phDo = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        { label: 'pH Level', data: phData, borderColor: '#9c27b0', backgroundColor: 'rgba(156,39,176,0.1)', tension: 0.2, yAxisID: 'y', borderWidth: 2 },
                        { label: 'pH Upper Limit (7.5)', data: Array(dataPoints.length).fill(7.5), borderColor: '#9c27b0', borderDash: [5,5], pointRadius: 0, yAxisID: 'y' },
                        { label: 'pH Lower Limit (6.5)', data: Array(dataPoints.length).fill(6.5), borderColor: '#9c27b0', borderDash: [5,5], pointRadius: 0, yAxisID: 'y' },
                        { label: 'Dissolved Oxygen (mg/L)', data: doData, borderColor: '#ff9800', backgroundColor: 'rgba(255,152,0,0.1)', tension: 0.2, yAxisID: 'y1', borderWidth: 2 },
                        { label: 'DO Threshold (5 mg/L)', data: Array(dataPoints.length).fill(5), borderColor: '#ff9800', borderDash: [5,5], pointRadius: 0, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm', hour: 'HH:mm', day: 'MMM dd' }, tooltipFormat: 'MMM dd, yyyy HH:mm' }, title: { display: true, text: `Time (${timezone})` } },
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'pH Level' }, min: 5, max: 9 },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Dissolved Oxygen (mg/L)' }, grid: { drawOnChartArea: false }, min: 0, max: 15 }
                    }
                }
            });
        }
        
        function updatePHDOChart() {
            if (!charts.phDo) return;
            let dataPoints = simulatedData;
            if (currentTimeRange === 1) dataPoints = simulatedData.slice(-60);
            else if (currentTimeRange === 6) dataPoints = simulatedData.slice(-360);
            else if (currentTimeRange === 24) dataPoints = simulatedData.slice(-1440);
            else if (currentTimeRange === 168) dataPoints = simulatedData.slice(-10080);
            else if (currentTimeRange === 720) dataPoints = simulatedData;
            
            charts.phDo.data.labels = dataPoints.map(d => new Date(d.timestamp));
            charts.phDo.data.datasets[0].data = dataPoints.map(d => d.ph);
            charts.phDo.data.datasets[3].data = dataPoints.map(d => d.do);
            charts.phDo.update();
        }
        
        function createChart(canvasId, dataset, labels, yAxisTitle, timezone) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: dataset.label, data: dataset.data, borderColor: dataset.color, backgroundColor: dataset.color + '20', fill: true, tension: 0.2, borderWidth: 2 },
                        { label: 'Threshold (' + dataset.threshold + ')', data: Array(dataset.data.length).fill(dataset.threshold), borderColor: dataset.color, borderDash: [5,5], pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'time', time: { unit: 'minute', displayFormats: { minute: 'HH:mm', hour: 'HH:mm', day: 'MMM dd' }, tooltipFormat: 'MMM dd, yyyy HH:mm' }, title: { display: true, text: `Time (${timezone})` } },
                        y: { title: { display: true, text: yAxisTitle } }
                    }
                }
            });
        }
        
        function updateGraphAnalysis() {
            if (simulatedData.length < 2) return;
            let exceedCount = 0;
            const recentData = simulatedData.slice(-10);
            recentData.forEach(point => {
                let pointExceed = 0;
                if (point.temperature > thresholds.temperature) pointExceed++;
                if (point.turbidity > thresholds.turbidity) pointExceed++;
                if (point.conductivity > thresholds.conductivity) pointExceed++;
                if (point.ph < thresholds.ph_low || point.ph > thresholds.ph_high) pointExceed++;
                if (point.do < thresholds.do) pointExceed++;
                if (pointExceed > exceedCount) exceedCount = pointExceed;
            });
            
            if (exceedCount >= 3) {
                document.getElementById('graphAnalysisText').innerHTML = `<span style="color: #f44336; font-weight: bold;">⚠️ HIGH PROBABILITY (${ballastCertainty.toFixed(0)}%) of Ballast Water</span> - ${exceedCount} sensors exceeding thresholds in recent data.`;
            } else if (exceedCount >= 1) {
                document.getElementById('graphAnalysisText').innerHTML = `<span style="color: #FF9800; font-weight: bold;">⚠️ POTENTIAL Contamination (${ballastCertainty.toFixed(0)}% certainty)</span> - ${exceedCount} sensor(s) showing abnormal readings.`;
            } else {
                document.getElementById('graphAnalysisText').innerHTML = `<span style="color: #4CAF50; font-weight: bold;">✓ NORMAL Conditions (${ballastCertainty.toFixed(0)}% certainty)</span> - All parameters within acceptable ranges.`;
            }
        }
        
        // Path functions
        function clearPath() {
            pathCoordinates = [];
            if (dronePathLayer) dronePathLayer.setLatLngs([]);
            if (trackingPathLayer) trackingPathLayer.setLatLngs([]);
            document.getElementById('distanceTraveled').textContent = 'Distance: 0 m';
        }
        
        function exportPath() {
            if (pathCoordinates.length === 0) { alert('No path data to export'); return; }
            const csvContent = 'latitude,longitude\n' + pathCoordinates.map(coord => `${coord[0]},${coord[1]}`).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `drone_path_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        // Statistics
        function loadStatistics() {
            const days = document.getElementById('statsPeriod').value;
            const stats = {
                temperature: { mean: 29.5 + Math.random()*2, median: 29.2 + Math.random()*2, std: 2.5 + Math.random(), min: 26 + Math.random()*2, max: 35 + Math.random()*3, q1: 28 + Math.random()*2, q3: 31 + Math.random()*2, count: 1000 },
                turbidity: { mean: 38.7 + Math.random()*5, median: 37.5 + Math.random()*5, std: 8.2 + Math.random()*2, min: 25 + Math.random()*5, max: 58 + Math.random()*10, q1: 32 + Math.random()*5, q3: 45 + Math.random()*5, count: 1000 },
                conductivity: { mean: 10.2 + Math.random()*2, median: 9.8 + Math.random()*2, std: 3.1 + Math.random(), min: 6 + Math.random()*2, max: 16 + Math.random()*4, q1: 8 + Math.random()*2, q3: 12 + Math.random()*2, count: 1000 },
                ph: { mean: 7.1 + Math.random()*0.3, median: 7.0 + Math.random()*0.3, std: 0.5 + Math.random()*0.2, min: 6.2 + Math.random()*0.5, max: 8.2 + Math.random()*0.5, q1: 6.8 + Math.random()*0.3, q3: 7.4 + Math.random()*0.3, count: 1000 },
                do: { mean: 5.8 + Math.random()*1, median: 5.7 + Math.random()*1, std: 1.2 + Math.random()*0.5, min: 3.5 + Math.random()*1, max: 8.5 + Math.random()*2, q1: 5.0 + Math.random()*1, q3: 6.5 + Math.random()*1, count: 1000 }
            };
            displayStatistics({ statistics: stats, sample_count: 1000 });
        }
        
        function displayStatistics(data) {
            const container = document.getElementById('statisticsContent');
            if (!data.statistics) {
                container.innerHTML = '<div class="card"><p style="color: #666; text-align: center; padding: 2rem;">No data available for the selected period</p></div>';
                return;
            }
            const stats = data.statistics;
            let html = '<div class="dashboard-grid">';
            const paramNames = { 'temperature': 'Temperature', 'turbidity': 'Turbidity', 'conductivity': 'Conductivity', 'ph': 'pH Level', 'do': 'Dissolved Oxygen' };
            for (const [param, paramStats] of Object.entries(stats)) {
                if (paramStats) {
                    html += `
                        <div class="card">
                            <div class="card-title"><i class="fas fa-chart-bar"></i> ${paramNames[param] || param} Statistics</div>
                            <div style="margin-top: 1rem;">
                                <table class="stats-table">
                                    <tr><td>Mean</td><td><strong>${paramStats.mean.toFixed(2)}</strong></td></tr>
                                    <tr><td>Maximum</td><td><strong>${paramStats.max.toFixed(2)}</strong></td></tr>
                                    <tr><td>Minimum</td><td><strong>${paramStats.min.toFixed(2)}</strong></td></tr>
                                    <tr><td>Std Deviation</td><td><strong>${paramStats.std.toFixed(2)}</strong></td></tr>
                                    <tr><td>Range</td><td><strong>${(paramStats.max - paramStats.min).toFixed(2)}</strong></td></tr>
                                    <tr><td>Q1 (25%)</td><td><strong>${paramStats.q1?.toFixed(2) || '--'}</strong></td></tr>
                                    <tr><td>Q3 (75%)</td><td><strong>${paramStats.q3?.toFixed(2) || '--'}</strong></td></tr>
                                    <tr><td>Count</td><td><strong>${paramStats.count}</strong></td></tr>
                                </table>
                            </div>
                        </div>
                    `;
                }
            }
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Debug
        async function loadDebugInfo() {
            try {
                const debugInfo = {
                    drone: { connected: true, reconnect_attempts: 0, port: 'SIMULATED', last_update: new Date().toISOString() },
                    camera: { initialized: true, type: 'USB Webcam' }
                };
                document.getElementById('debugDroneStatus').textContent = debugInfo.drone.connected ? 'Connected' : 'Disconnected';
                document.getElementById('debugReconnectAttempts').textContent = debugInfo.drone.reconnect_attempts;
                document.getElementById('debugSerialPort').textContent = debugInfo.drone.port;
                
                if (debugInfo.drone.last_update) {
                    const date = new Date(debugInfo.drone.last_update);
                    document.getElementById('lastDataReceived').textContent = date.toLocaleString('en-US', { timeZone: timezone });
                }
                
                document.getElementById('debugCameraStatus').textContent = debugInfo.camera.initialized ? 'Connected' : 'Not Connected';
                document.getElementById('cameraFeedStatus').textContent = debugInfo.camera.initialized ? 'Live' : 'Offline';
                document.getElementById('cameraFeedStatus2').textContent = debugInfo.camera.initialized ? 'Live' : 'Offline';
                document.getElementById('cameraType').textContent = `(${debugInfo.camera.type})`;
                document.getElementById('cameraType2').textContent = `(${debugInfo.camera.type})`;
                
                const cameraStatusDot = document.getElementById('cameraStatusDot');
                const cameraStatusText = document.getElementById('cameraStatusText');
                if (debugInfo.camera.initialized) {
                    cameraStatusDot.className = 'indicator-dot connected';
                    cameraStatusText.textContent = 'Active';
                } else {
                    cameraStatusDot.className = 'indicator-dot disconnected';
                    cameraStatusText.textContent = 'Offline';
                }
            } catch (error) {
                console.error('Error loading debug info:', error);
            }
        }
        
        async function loadSystemLogs() {
            const level = document.getElementById('logLevel').value;
            const source = document.getElementById('logSource').value;
            try {
                const logs = [];
                const levels = ['info', 'warning', 'error'];
                const sources = ['drone', 'camera', 'system'];
                for (let i = 0; i < 20; i++) {
                    const logLevel = levels[Math.floor(Math.random() * levels.length)];
                    const logSource = sources[Math.floor(Math.random() * sources.length)];
                    if ((level && level !== logLevel) || (source && source !== logSource)) continue;
                    const timestamp = new Date(Date.now() - Math.random() * 86400000);
                    const messages = ['Drone data received successfully','Camera feed initialized','Sensor calibration completed','Ballast water probability calculated','GPS signal acquired','Data transmission in progress','System health check passed','Threshold alert triggered','Data logging resumed','Connection established'];
                    logs.push({
                        timestamp: timestamp.toISOString(),
                        source: logSource,
                        level: logLevel,
                        message: messages[Math.floor(Math.random() * messages.length)]
                    });
                }
                const tbody = document.getElementById('logTableBody');
                tbody.innerHTML = '';
                logs.forEach(log => {
                    const row = document.createElement('tr');
                    const date = new Date(log.timestamp);
                    const timeStr = date.toLocaleTimeString('en-US', { timeZone: timezone, hour12: false });
                    let levelColor;
                    switch(log.level) {
                        case 'info': levelColor = '#2196F3'; break;
                        case 'warning': levelColor = '#FF9800'; break;
                        case 'error': levelColor = '#f44336'; break;
                        case 'critical': levelColor = '#d32f2f'; break;
                        default: levelColor = '#666';
                    }
                    row.innerHTML = `
                        <td style="padding: 0.8rem 1rem; border-bottom: 1px solid #eee;">${timeStr}</td>
                        <td style="padding: 0.8rem 1rem; border-bottom: 1px solid #eee;"><span style="background: #f0f0f0; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.8rem;">${log.source}</span></td>
                        <td style="padding: 0.8rem 1rem; border-bottom: 1px solid #eee;"><span style="color: ${levelColor}; font-weight: 500;">${log.level.toUpperCase()}</span></td>
                        <td style="padding: 0.8rem 1rem; border-bottom: 1px solid #eee;">${log.message}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading system logs:', error);
            }
        }
        
        function reconnectDrone() { alert('Drone reconnected successfully (simulation)'); loadDebugInfo(); }
        function reconnectCamera() { alert('Camera reconnected successfully (simulation)'); loadDebugInfo(); }
        function refreshDebugInfo() { loadDebugInfo(); loadSystemLogs(); }
        
        function exportLogs() {
            const logs = [];
            for (let i = 0; i < 50; i++) {
                const timestamp = new Date(Date.now() - Math.random() * 86400000);
                logs.push({
                    timestamp: timestamp.toISOString(),
                    source: ['drone', 'camera', 'system'][Math.floor(Math.random() * 3)],
                    level: ['info', 'warning', 'error'][Math.floor(Math.random() * 3)],
                    message: 'Simulated log entry ' + (i + 1)
                });
            }
            const csvContent = logs.map(log => `"${log.timestamp}","${log.source}","${log.level}","${log.message}"`).join('\n');
            const header = 'Timestamp,Source,Level,Message\n';
            const blob = new Blob([header + csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `system_logs_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function setExportDateRange(days) {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - days);
            document.getElementById('exportStartDate').valueAsDate = start;
            document.getElementById('exportEndDate').valueAsDate = end;
        }
        
        function exportDroneData() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;
            const format = document.getElementById('exportFormat').value;
            const exportData = simulatedData.map(point => ({
                timestamp: point.timestamp,
                temperature: point.temperature,
                turbidity: point.turbidity,
                conductivity: point.conductivity,
                ph: point.ph,
                do: point.do,
                latitude: point.latitude,
                longitude: point.longitude,
                battery: point.battery
            }));
            if (format === 'csv') {
                const csvContent = exportData.map(point => 
                    `"${point.timestamp}",${point.temperature},${point.turbidity},${point.conductivity},${point.ph},${point.do},${point.latitude},${point.longitude},${point.battery}`
                ).join('\n');
                const header = 'Timestamp,Temperature (°C),Turbidity (NTU),Conductivity (mS/cm),pH,Dissolved Oxygen (mg/L),Latitude,Longitude,Battery (%)\n';
                const blob = new Blob([header + csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `drone_data_${startDate}_to_${endDate}.csv`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            } else {
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `drone_data_${startDate}_to_${endDate}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }
            alert(`Exporting drone data from ${startDate} to ${endDate}...`);
        }
        
        window.addEventListener('beforeunload', function() {
            if (updateInterval) clearInterval(updateInterval);
            Object.values(charts).forEach(chart => { if (chart && chart.destroy) chart.destroy(); });
        });
    </script>
</body>
</html>